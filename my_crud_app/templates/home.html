{% extends 'base.html' %}
{% block title %}Projects{% endblock %}

{% block content %} 
    <div class="row">
      <div class="col-md-4 ">
        <h3>ADD Project</h3>
        <form id="addProject" action="">
            {% csrf_token %}
          <div class="form-group">
            <input class="form-control" type="text" name="name" placeholder="Name" required>
          </div>
          <div class="form-group">
            <input class="form-control" type="text" name="description" placeholder="Description" required>
          </div>
          <div class="form-group">
            <input class="form-control" type="date" name="start_date" required>
          </div>
          <div class="form-group">
            <input class="form-control" type="date" name="end_date" required>
          </div>
          
          <button class="btn btn-primary form-control" type="submit">SUBMIT</button>
        </form>
      </div>
      <div class="col-md-8">
        <h3>Projects</h3>
        <table id="projectTable" class="table table-striped">
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Start Date</th>
            <th colspan="4">End Date</th>
          </tr>
          {% for project in projects %}
          <tr id="project-{{project.id}}">
              <td class="projectName projectData" name="name">{{project.name}}</td>
              <td class="projectDescription projectData" name="description">{{project.description}}</td>
              <td class="projectStartDate projectData" name="start_date">{{project.start_date|date:'Y-m-d'}}</td>
              <td class="projectEndDate projectData" name="end_date">{{project.end_date|date:'Y-m-d'}}</td>
              <td align="center">
                <a href="{% url 'project_detail' project.id %}"><button class="btn btn-info form-control">INFO</button></a>
              </td>
              <td align="center">
                  <button class="btn btn-success form-control" onClick="editProject({{project.id}})" data-toggle="modal" data-target="#myModal")">EDIT</button>
              </td>
               <td align="center">
                  <button class="btn btn-danger form-control" onClick="deleteProject({{project.id}})">DELETE</button>
              </td> 
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>

    <!-- update project modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="myModalLabel">Update Project</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <form id="updateProject" action="">
            <div class="modal-body">
                <input class="form-control" id="form-id" type="hidden" name="formId"/>
                <label for="name">Name</label>
                <input class="form-control" id="form-name" type="text" name="formName"/>
                <label for="description">Description</label>
                <input class="form-control" id="form-description" type="text" name="formDescription"/>
                <label for="start_date">Start Date</label>
                <input class="form-control" id="form-start_date" type="date" name="formStartDate" />
                <label for="end_date">End Date</label>
                <input class="form-control" id="form-end_date" type="date" name="formEndDate" />
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary" >Save changes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            </form>
          </div>
        </div>
      </div>

{% endblock %}

{% block javascript %}
<script>

function appendToProjectTable(project, project_details_url) {
  $("#projectTable > tbody:last-child").append(`
        <tr id="project-${project.id}">
            <td class="projectName" name="name">${project.name}</td>
            '<td class="projectDescription" name="description">${project.description}</td>
            '<td class="projectStartDate" name="start_date">${project.start_date}</td>
            <td class="projectEndDate projectData" name="end_date">${project.end_date}</td>
            <td align="center">
                <a href="${project_details_url}"><button class="btn btn-info form-control">INFO</button></a>
              </td>
            <td align="center">
                <button class="btn btn-success form-control" onClick="editProject(${project.id})" data-toggle="modal" data-target="#myModal")">EDIT</button>
            </td>
            <td align="center">
                <button class="btn btn-danger form-control" onClick="deleteProject(${project.id})">DELETE</button>
            </td>
        </tr>
    `);
}




function deleteProject(id) {
  var action = confirm("Are you sure you want to delete this project?");
  if (action != false) {
    $.ajax({
        url: '{% url "project_delete" %}',
        method: "post",
        data: {
            'id': id,
        },
        dataType: 'json',
        success: function (data) {
            if (data.deleted) {
              $("#projectTable #project-" + id).remove();
            }
        }
    });
  }
}

function editProject(id) {
  if (id) {
    tr_id = "#project-" + id;
    name = $(tr_id).find(".projectName").text();
    description = $(tr_id).find(".projectDescription").text();
    start_date = $(tr_id).find(".projectStartDate").text();
    end_date = $(tr_id).find(".projectEndDate").text();
    
    $('#form-id').val(id);
    $('#form-name').val(name);
    $('#form-description').val(description);
    $('#form-start_date').val(start_date);
    $('#form-end_date').val(end_date);
  }
}

function updateToProjectTabel(project){
    $("#projectTable #project-" + project.id).children(".projectData").each(function() {
        var attr = $(this).attr("name");
        if (attr == "name") {
          $(this).text(project.name);
        } else if (attr == "description") {
          $(this).text(project.description);
        } else if (attr == "start_date") {
          $(this).text(project.start_date);
        } else {
          $(this).text(project.end_date);
        }
      });
}


$("form#addProject").submit(function() {
    var nameInput = $('input[name="name"]').val().trim();
    var description = $('input[name="description"]').val().trim();
    var startDateInput = $('input[name="start_date"]').val().trim();
    var endDateInput = $('input[name="end_date"]').val().trim();
    if (nameInput && description && startDateInput && endDateInput) {

        $.ajax({
            url: '{% url "project_create" %}',
            method: "post",
            data: {
                'name': nameInput,
                'description': description,
                'start_date': startDateInput,
                'end_date': endDateInput
            },
            dataType: 'json',
            success: function (data) {
                if (data.project) {
                    appendToProjectTable(data.project, data.project_details_url);
                }
            }
        });

    } else {
        alert("All fields must have a valid value.");
    }
    $('form#addProject').trigger("reset");
    return false;
});

$("form#updateProject").submit(function() {
    var idInput = $('input[name="formId"]').val().trim();
    var nameInput = $('input[name="formName"]').val().trim();
    var description = $('input[name="formDescription"]').val().trim();
    var startDateInput = $('input[name="formStartDate"]').val().trim();
    var endDateInput = $('input[name="formEndDate"]').val().trim();
    if (nameInput && description && startDateInput && endDateInput) {
        // Create Ajax Call
        $.ajax({
            url: '{% url "project_update" %}',
            method: "post",
            data: {
                'id': idInput,
                'name': nameInput,
                'description': description,
                'start_date': startDateInput,
                'end_date': endDateInput
            },
            dataType: 'json',
            success: function (data) {
                // console.log("data------>", data);
                if (data.project) {
                  updateToProjectTabel(data.project);
                }
            }
        });

    } else {
        alert("All fields must have a valid value.");
    }
    $('form#updateProject').trigger("reset");
    $('#myModal').modal('hide');
    return false;
});


</script>

{% endblock %}